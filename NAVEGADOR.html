<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NAVEGADOR</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }

    .hud{
      transform: scale(.9);
      transform-origin: top left;
      position: absolute;
      z-index: 9999;
      top: 12px;
      left: 12px;
      background: rgba(255,255,255,.92);
      padding: 10px 12px;
      border-radius: 10px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-size: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,.15);
    }

    .follow{
      display:flex;
      align-items:center;
      gap:4px;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <div class="hud" id="hud">
    <div class="hud-header">
      <button id="recenterBtn" type="button">Centrarme</button>
      <label class="follow">
        <input id="followChk" type="checkbox" checked />
        seguirme
      </label>
    </div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    (() => {
      "use strict";

      const $ = (id) => document.getElementById(id);
      const followChk = $("followChk");
      const recenterBtn = $("recenterBtn");
      const mapEl = $("map");

      let lastLatLng = null;
      let lastBearing = NaN;

      // Inicializa el mapa
      const map = L.map("map").setView([40.4168, -3.7038], 6);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

      let mapRotDeg = 0;
      let mapRotTarget = 0;
      let mapRotRaf = 0;

      const setMapRotationDegrees = (deg) => {
        const d = (typeof deg === "number" && isFinite(deg)) ? deg : 0;
        mapRotTarget = -d;
        while (mapRotTarget > 180) mapRotTarget -= 360;
        while (mapRotTarget < -180) mapRotTarget += 360;
        if (!mapRotRaf) mapRotRaf = requestAnimationFrame(animateMapRotation);
      };

      const animateMapRotation = () => {
        mapRotRaf = 0;
        const diff = mapRotTarget - mapRotDeg;
        mapRotDeg = Math.abs(diff) < 0.5 ? mapRotTarget : (mapRotDeg + diff * 0.18);

        mapEl.style.transform = `rotate(${mapRotDeg}deg)`;

        if (Math.abs(mapRotTarget - mapRotDeg) >= 0.5) {
          mapRotRaf = requestAnimationFrame(animateMapRotation);
        }
      };

      const clearMapRotation = () => {
        mapRotTarget = 0;
        mapRotDeg = 0;
        mapEl.style.transform = `rotate(0deg)`;
      };

      const updateMyLocation = (pos) => {
        const { latitude, longitude, accuracy, heading } = pos.coords;
        const nextLatLng = L.latLng(latitude, longitude);

        lastLatLng = nextLatLng;

        let bearing = (typeof heading === "number" && isFinite(heading)) ? heading : NaN;

        // Si no se tiene un rumbo (heading) confiable, intenta estimarlo a partir de los puntos anteriores
        if (!isFinite(bearing)) {
          bearing = lastBearing;
        }

        if (isFinite(bearing)) lastBearing = bearing;

        if (followChk.checked) {
          setMapRotationDegrees(bearing); // Rota el mapa según el rumbo del usuario
        } else {
          clearMapRotation(); // Si "seguirme" no está activado, se detiene la rotación
        }

        map.setView(nextLatLng, 17); // Centra el mapa en la nueva ubicación
      };

      // Configuración de la geolocalización
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(updateMyLocation, () => {}, {
          enableHighAccuracy: true,
          maximumAge: 1000,
          timeout: 10000
        });
      }

      // Función para recentrar el mapa al clic
      recenterBtn.addEventListener("click", () => {
        if (lastLatLng) {
          map.setView(lastLatLng, 17);
        }
      });

      followChk.addEventListener("change", () => {
        if (followChk.checked) {
          if (lastBearing) {
            setMapRotationDegrees(lastBearing);
          }
        } else {
          clearMapRotation();
        }
      });
    })();
  </script>
</body>
</html>
