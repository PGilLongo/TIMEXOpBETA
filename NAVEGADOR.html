<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NAVEGADOR</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html,body{height:100%;margin:0}
#map{height:100%;width:100%}

/* ===== MAP ROTATION ===== */
#map.rotate .map-rotator{
  transform: rotate(var(--map-rot,0deg)) scale(var(--map-scale,1));
}
.map-rotator{
  position:absolute;
  inset:0;
  transform-origin:50% 50%;
  will-change:transform;
}

/* ===== SIMPLE ME ICON ===== */
.me-dot{
  width:14px;
  height:14px;
  border-radius:50%;
  background:#2b6cff;
  border:3px solid #fff;
  box-shadow:0 2px 8px rgba(0,0,0,.35);
}
</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
(()=>{
"use strict";

/* ================= MAP ================= */
const map = L.map("map").setView([40.4168,-3.7038],6);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

/* ===== ROTATION WRAPPER ===== */
const mapRotWrap=(()=>{
  const pane=map.getPane("mapPane");
  const wrap=document.createElement("div");
  wrap.className="map-rotator";
  pane.parentNode.insertBefore(wrap,pane);
  wrap.appendChild(pane);
  return wrap;
})();

/* ================= STATE ================= */
let myMarker=null;
let lastLatLng=null;
let lastBearing=NaN;

let mapRotDeg=0;
let mapRotTarget=0;
let mapRotRaf=0;

/* ================= ICON ================= */
const meIcon=L.divIcon({
  className:"",
  html:`<div class="me-dot"></div>`,
  iconSize:[14,14],
  iconAnchor:[7,7]
});

/* ================= ROTATION ================= */
function setMapRotationDegrees(deg){
  mapRotTarget=-deg;
  while(mapRotTarget>180)mapRotTarget-=360;
  while(mapRotTarget<-180)mapRotTarget+=360;
  if(!mapRotRaf)mapRotRaf=requestAnimationFrame(animateRotation);
}

function animateRotation(){
  mapRotRaf=0;
  const diff=mapRotTarget-mapRotDeg;
  mapRotDeg+=diff*0.18;

  const scale=Math.abs(mapRotDeg)>1?1.12:1;
  map.getContainer().classList.add("rotate");
  map.getContainer().style.setProperty("--map-rot",`${mapRotDeg}deg`);
  map.getContainer().style.setProperty("--map-scale",scale);

  if(Math.abs(diff)>0.5) mapRotRaf=requestAnimationFrame(animateRotation);
}

function clearRotation(){
  mapRotDeg=mapRotTarget=0;
  map.getContainer().style.setProperty("--map-rot","0deg");
  map.getContainer().style.setProperty("--map-scale","1");
  map.getContainer().classList.remove("rotate");
}

/* ================= GEO ================= */
const toRad=d=>d*Math.PI/180;
const toDeg=r=>r*180/Math.PI;

function bearingBetween(a,b){
  const φ1=toRad(a.lat),φ2=toRad(b.lat);
  const Δλ=toRad(b.lng-a.lng);
  const y=Math.sin(Δλ)*Math.cos(φ2);
  const x=Math.cos(φ1)*Math.sin(φ2)-Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
  return (toDeg(Math.atan2(y,x))+360)%360;
}

/* ================= LOCATION ================= */
function updateMyLocation(pos){
  const {latitude,longitude,heading}=pos.coords;
  const ll=L.latLng(latitude,longitude);
  if(!myMarker){
    myMarker=L.marker(ll,{icon:meIcon}).addTo(map);
    map.setView(ll,17);
  }else{
    myMarker.setLatLng(ll);
  }

  if(lastLatLng){
    let b=isFinite(heading)?heading:bearingBetween(lastLatLng,ll);
    if(isFinite(b)){
      lastBearing=b;
      setMapRotationDegrees(b);
    }
  }

  lastLatLng=ll;
  map.panTo(ll,{animate:true});
}

/* ================= START ================= */
navigator.geolocation.watchPosition(updateMyLocation,()=>{},{
  enableHighAccuracy:true,
  maximumAge:1000,
  timeout:10000
});

})();
</script>
</body>
</html>
